# =============================================================================
# GitHub Actions Workflow for @tinyland-inc standalone packages
#
# Triggers:
#   - Push to main: test only
#   - Tag v*: test + publish to GitHub Packages + GitLab Package Registry
#   - Manual: workflow_dispatch for ad-hoc publish
#
# Required Secrets:
#   GITLAB_TOKEN       - GitLab PAT with api scope (for GitLab registry publish)
#   GITLAB_PROJECT_ID  - GitLab project ID (for registry URL)
# =============================================================================

name: CI & Publish

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to registries'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: pnpm run test

  publish-github:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@tinyland-inc'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-gitlab:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build

      - name: Publish to GitLab Package Registry
        run: |
          echo "@tinyland-inc:registry=https://gitlab.com/api/v4/projects/${{ secrets.GITLAB_PROJECT_ID }}/packages/npm/" > .npmrc
          echo "//gitlab.com/api/v4/projects/${{ secrets.GITLAB_PROJECT_ID }}/packages/npm/:_authToken=${{ secrets.GITLAB_TOKEN }}" >> .npmrc
          npm publish --registry="https://gitlab.com/api/v4/projects/${{ secrets.GITLAB_PROJECT_ID }}/packages/npm/"
          rm -f .npmrc

  # Future: Publish to npm public registry
  # publish-npm:
  #   needs: test
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/setup-node@v4
  #       with:
  #         registry-url: 'https://registry.npmjs.org'
  #     - run: npm publish --access public
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
