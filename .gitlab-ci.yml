# =============================================================================
# GitLab CI/CD Template for @tummycrypt standalone packages
#
# Usage: Copy to .gitlab-ci.yml in each standalone package repo.
# Required CI/CD Variables:
#   NPM_TOKEN         - npm registry auth token (for future npm publish)
#   GITLAB_TOKEN       - GitLab token with api scope (auto-provided in CI)
#   GITHUB_TOKEN       - GitHub PAT for GitHub Packages publish
#   GITHUB_REPO        - GitHub repo (e.g., tinyland-inc/tinyvectors)
# =============================================================================

stages:
  - validate
  - test
  - publish

variables:
  PNPM_STORE_DIR: .pnpm-store
  NODE_VERSION: '22'

default:
  timeout: 5 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  image:
    name: node:${NODE_VERSION}-bookworm
    pull_policy: always

.pnpm-cache: &pnpm-cache
  key:
    files:
      - pnpm-lock.yaml
    prefix: pnpm-${CI_COMMIT_REF_SLUG}
  paths:
    - ${PNPM_STORE_DIR}
  policy: pull-push

.setup-pnpm: &setup-pnpm
  - corepack enable
  - corepack prepare pnpm@10.13.1 --activate
  - pnpm config set store-dir ${PNPM_STORE_DIR}
  - |
    # Configure GitHub Packages auth for @tummycrypt dependencies
    if [ -n "${GITHUB_TOKEN:-}" ]; then
      echo "@tummycrypt:registry=https://npm.pkg.github.com" > .npmrc
      echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> .npmrc
    fi
  - |
    if [ -f pnpm-lock.yaml ]; then
      pnpm install --frozen-lockfile
    else
      echo "No lockfile found, generating..."
      pnpm install
    fi

# ---------------------------------------------------------------------------
# Stage: validate
# ---------------------------------------------------------------------------

lint:
  stage: validate
  cache:
    - <<: *pnpm-cache
      policy: pull
  before_script:
    - *setup-pnpm
  script:
    - pnpm run lint || echo "No lint script configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

typecheck:
  stage: validate
  cache:
    - <<: *pnpm-cache
      policy: pull
  before_script:
    - *setup-pnpm
  script:
    - pnpm run typecheck || pnpm tsc --noEmit || echo "No typecheck configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ---------------------------------------------------------------------------
# Stage: test
# ---------------------------------------------------------------------------

test:
  stage: test
  cache:
    - <<: *pnpm-cache
      policy: pull
  before_script:
    - *setup-pnpm
  script:
    - pnpm run build 2>/dev/null || echo "No build script configured, skipping..."
    - pnpm run test
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ---------------------------------------------------------------------------
# Stage: publish
# ---------------------------------------------------------------------------

# Publish to GitLab Package Registry
publish-gitlab:
  stage: publish
  cache:
    - <<: *pnpm-cache
      policy: pull
  before_script:
    - *setup-pnpm
    - |
      echo "Configuring GitLab Package Registry..."
      echo "@tummycrypt:registry=https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" > .npmrc
      echo "//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
  script:
    - pnpm run build 2>/dev/null || echo "No build script, skipping..."
    - npm publish --registry="https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
  after_script:
    - rm -f .npmrc
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# Publish to GitHub Packages
publish-github:
  stage: publish
  cache:
    - <<: *pnpm-cache
      policy: pull
  before_script:
    - *setup-pnpm
    - |
      if [ -z "${GITHUB_TOKEN:-}" ]; then
        echo "ERROR: GITHUB_TOKEN not set. Skipping GitHub publish."
        exit 1
      fi
      echo "Configuring GitHub Packages..."
      echo "@tummycrypt:registry=https://npm.pkg.github.com" > .npmrc
      echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> .npmrc
  script:
    - pnpm run build 2>/dev/null || echo "No build script, skipping..."
    - npm publish --registry="https://npm.pkg.github.com"
  after_script:
    - rm -f .npmrc
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# Future: Publish to npm public registry
# publish-npm:
#   stage: publish
#   before_script:
#     - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
#   script:
#     - pnpm run build
#     - npm publish --access public
#   rules:
#     - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/