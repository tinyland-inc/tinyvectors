{"version":3,"file":"SpatialHash.js","names":["results: ConvexBlob[]","pairs: Array<[ConvexBlob, ConvexBlob, number]>"],"sources":["../../src/core/SpatialHash.ts"],"sourcesContent":["/**\n * Spatial Hash for O(n) collision detection\n *\n * Divides space into a grid of cells. Each blob is assigned to a cell\n * based on its position. Collision queries only check neighboring cells.\n *\n * Time complexity:\n * - Rebuild: O(n)\n * - Query: O(k) where k = average blobs per cell neighborhood\n * - vs brute force O(nÂ²)\n */\n\nimport type { ConvexBlob } from './types.js';\n\nexport class SpatialHash {\n\tprivate cellSize: number;\n\tprivate cells: Map<string, ConvexBlob[]>;\n\tprivate blobToCell: Map<ConvexBlob, string>;\n\n\t/**\n\t * Create a spatial hash\n\t * @param cellSize - Size of each grid cell (should be ~2x max blob interaction radius)\n\t */\n\tconstructor(cellSize: number = 50) {\n\t\tthis.cellSize = cellSize;\n\t\tthis.cells = new Map();\n\t\tthis.blobToCell = new Map();\n\t}\n\n\t/**\n\t * Compute cell key from world position\n\t */\n\tprivate hash(x: number, y: number): string {\n\t\tconst cellX = Math.floor(x / this.cellSize);\n\t\tconst cellY = Math.floor(y / this.cellSize);\n\t\treturn `${cellX},${cellY}`;\n\t}\n\n\t/**\n\t * Parse cell key back to cell coordinates\n\t */\n\tprivate parseKey(key: string): { cellX: number; cellY: number } {\n\t\tconst [cellX, cellY] = key.split(',').map(Number);\n\t\treturn { cellX, cellY };\n\t}\n\n\t/**\n\t * Rebuild the spatial hash with current blob positions\n\t * Call this once per frame before collision queries\n\t *\n\t * @param blobs - All blobs to index\n\t */\n\trebuild(blobs: ConvexBlob[]): void {\n\t\tthis.cells.clear();\n\t\tthis.blobToCell.clear();\n\n\t\tfor (const blob of blobs) {\n\t\t\tconst key = this.hash(blob.currentX, blob.currentY);\n\n\t\t\tif (!this.cells.has(key)) {\n\t\t\t\tthis.cells.set(key, []);\n\t\t\t}\n\n\t\t\tthis.cells.get(key)!.push(blob);\n\t\t\tthis.blobToCell.set(blob, key);\n\t\t}\n\t}\n\n\t/**\n\t * Query all blobs within radius of a position\n\t *\n\t * @param x - Query X position\n\t * @param y - Query Y position\n\t * @param radius - Search radius\n\t * @param excludeBlob - Optional blob to exclude from results\n\t * @returns Array of blobs within radius\n\t */\n\tquery(x: number, y: number, radius: number, excludeBlob?: ConvexBlob): ConvexBlob[] {\n\t\tconst results: ConvexBlob[] = [];\n\t\tconst cellRadius = Math.ceil(radius / this.cellSize);\n\t\tconst radiusSquared = radius * radius;\n\n\t\tconst centerCellX = Math.floor(x / this.cellSize);\n\t\tconst centerCellY = Math.floor(y / this.cellSize);\n\n\t\t// Check all cells within range\n\t\tfor (let dx = -cellRadius; dx <= cellRadius; dx++) {\n\t\t\tfor (let dy = -cellRadius; dy <= cellRadius; dy++) {\n\t\t\t\tconst key = `${centerCellX + dx},${centerCellY + dy}`;\n\t\t\t\tconst cell = this.cells.get(key);\n\n\t\t\t\tif (cell) {\n\t\t\t\t\tfor (const blob of cell) {\n\t\t\t\t\t\tif (blob === excludeBlob) continue;\n\n\t\t\t\t\t\t// Distance check\n\t\t\t\t\t\tconst blobDx = blob.currentX - x;\n\t\t\t\t\t\tconst blobDy = blob.currentY - y;\n\t\t\t\t\t\tconst distSquared = blobDx * blobDx + blobDy * blobDy;\n\n\t\t\t\t\t\tif (distSquared < radiusSquared) {\n\t\t\t\t\t\t\tresults.push(blob);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\t/**\n\t * Query neighbors of a specific blob\n\t *\n\t * @param blob - The blob to find neighbors for\n\t * @param radius - Search radius\n\t * @returns Array of neighboring blobs\n\t */\n\tqueryNeighbors(blob: ConvexBlob, radius: number): ConvexBlob[] {\n\t\treturn this.query(blob.currentX, blob.currentY, radius, blob);\n\t}\n\n\t/**\n\t * Get all blob pairs within interaction distance\n\t * Useful for bulk collision processing\n\t *\n\t * @param interactionRadius - Maximum interaction distance\n\t * @returns Array of [blob1, blob2, distance] tuples\n\t */\n\tgetAllPairs(interactionRadius: number): Array<[ConvexBlob, ConvexBlob, number]> {\n\t\tconst pairs: Array<[ConvexBlob, ConvexBlob, number]> = [];\n\t\tconst processed = new Set<string>();\n\t\tconst radiusSquared = interactionRadius * interactionRadius;\n\n\t\tfor (const [key, blobs] of this.cells) {\n\t\t\tconst { cellX, cellY } = this.parseKey(key);\n\n\t\t\t// Check blobs within same cell\n\t\t\tfor (let i = 0; i < blobs.length; i++) {\n\t\t\t\tfor (let j = i + 1; j < blobs.length; j++) {\n\t\t\t\t\tconst b1 = blobs[i];\n\t\t\t\t\tconst b2 = blobs[j];\n\n\t\t\t\t\tconst dx = b2.currentX - b1.currentX;\n\t\t\t\t\tconst dy = b2.currentY - b1.currentY;\n\t\t\t\t\tconst distSquared = dx * dx + dy * dy;\n\n\t\t\t\t\tif (distSquared < radiusSquared) {\n\t\t\t\t\t\tpairs.push([b1, b2, Math.sqrt(distSquared)]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Check neighboring cells (only forward neighbors to avoid duplicates)\n\t\t\tconst neighborOffsets = [\n\t\t\t\t[1, 0],\n\t\t\t\t[1, 1],\n\t\t\t\t[0, 1],\n\t\t\t\t[-1, 1],\n\t\t\t];\n\n\t\t\tfor (const [dx, dy] of neighborOffsets) {\n\t\t\t\tconst neighborKey = `${cellX + dx},${cellY + dy}`;\n\t\t\t\tconst neighborBlobs = this.cells.get(neighborKey);\n\n\t\t\t\tif (neighborBlobs) {\n\t\t\t\t\tfor (const b1 of blobs) {\n\t\t\t\t\t\tfor (const b2 of neighborBlobs) {\n\t\t\t\t\t\t\tconst blobDx = b2.currentX - b1.currentX;\n\t\t\t\t\t\t\tconst blobDy = b2.currentY - b1.currentY;\n\t\t\t\t\t\t\tconst distSquared = blobDx * blobDx + blobDy * blobDy;\n\n\t\t\t\t\t\t\tif (distSquared < radiusSquared) {\n\t\t\t\t\t\t\t\tpairs.push([b1, b2, Math.sqrt(distSquared)]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn pairs;\n\t}\n\n\t/**\n\t * Get cell size\n\t */\n\tgetCellSize(): number {\n\t\treturn this.cellSize;\n\t}\n\n\t/**\n\t * Get number of occupied cells (for debugging)\n\t */\n\tgetCellCount(): number {\n\t\treturn this.cells.size;\n\t}\n\n\t/**\n\t * Get cell contents (for debugging)\n\t */\n\tgetCell(x: number, y: number): ConvexBlob[] {\n\t\tconst key = this.hash(x, y);\n\t\treturn this.cells.get(key) || [];\n\t}\n\n\t/**\n\t * Clear the hash\n\t */\n\tclear(): void {\n\t\tthis.cells.clear();\n\t\tthis.blobToCell.clear();\n\t}\n}\n"],"mappings":"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"}