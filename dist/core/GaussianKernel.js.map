{"version":3,"file":"GaussianKernel.js","names":[],"sources":["../../src/core/GaussianKernel.ts"],"sourcesContent":["/**\n * Gaussian Kernel for smooth control point convolution\n *\n * Replaces simple 3-point averaging with proper Gaussian smoothing\n * that preserves shape continuity and reduces high-frequency noise.\n */\n\nimport type { ControlPoint } from './types.js';\n\nexport class GaussianKernel {\n\tprivate weights: Float32Array;\n\tprivate halfSize: number;\n\tprivate size: number;\n\n\t/**\n\t * Create a Gaussian kernel\n\t * @param size - Kernel size (must be odd, e.g., 3, 5, 7)\n\t * @param sigma - Standard deviation (higher = more smoothing)\n\t */\n\tconstructor(size: number = 5, sigma: number = 1.0) {\n\t\t// Ensure odd size\n\t\tthis.size = size % 2 === 0 ? size + 1 : size;\n\t\tthis.halfSize = Math.floor(this.size / 2);\n\t\tthis.weights = new Float32Array(this.size);\n\n\t\tthis.computeWeights(sigma);\n\t}\n\n\t/**\n\t * Compute normalized Gaussian weights\n\t */\n\tprivate computeWeights(sigma: number): void {\n\t\tlet sum = 0;\n\t\tconst twoSigmaSquared = 2 * sigma * sigma;\n\n\t\tfor (let i = 0; i < this.size; i++) {\n\t\t\tconst x = i - this.halfSize;\n\t\t\tconst weight = Math.exp(-(x * x) / twoSigmaSquared);\n\t\t\tthis.weights[i] = weight;\n\t\t\tsum += weight;\n\t\t}\n\n\t\t// Normalize so weights sum to 1\n\t\tfor (let i = 0; i < this.size; i++) {\n\t\t\tthis.weights[i] /= sum;\n\t\t}\n\t}\n\n\t/**\n\t * Convolve control point radii with Gaussian kernel\n\t * Uses circular buffer wrap-around for closed shapes\n\t *\n\t * @param points - Array of control points to smooth (mutates in place)\n\t */\n\tconvolve(points: ControlPoint[]): void {\n\t\tconst n = points.length;\n\t\tif (n < 3) return;\n\n\t\t// Copy original radii to avoid reading modified values\n\t\tconst originalRadii = new Float32Array(n);\n\t\tfor (let i = 0; i < n; i++) {\n\t\t\toriginalRadii[i] = points[i].radius;\n\t\t}\n\n\t\t// Apply kernel with circular wrap\n\t\tfor (let i = 0; i < n; i++) {\n\t\t\tlet smoothedRadius = 0;\n\n\t\t\tfor (let j = 0; j < this.size; j++) {\n\t\t\t\t// Circular index wrap-around\n\t\t\t\tconst idx = (i + j - this.halfSize + n) % n;\n\t\t\t\tsmoothedRadius += originalRadii[idx] * this.weights[j];\n\t\t\t}\n\n\t\t\tpoints[i].radius = smoothedRadius;\n\t\t}\n\t}\n\n\t/**\n\t * Convolve a Float32Array of radii (for worker/WASM use)\n\t *\n\t * @param radii - Array of radii values\n\t * @param count - Number of control points\n\t * @returns New Float32Array with smoothed values\n\t */\n\tconvolveArray(radii: Float32Array, count: number): Float32Array {\n\t\tconst result = new Float32Array(count);\n\n\t\tfor (let i = 0; i < count; i++) {\n\t\t\tlet smoothedRadius = 0;\n\n\t\t\tfor (let j = 0; j < this.size; j++) {\n\t\t\t\tconst idx = (i + j - this.halfSize + count) % count;\n\t\t\t\tsmoothedRadius += radii[idx] * this.weights[j];\n\t\t\t}\n\n\t\t\tresult[i] = smoothedRadius;\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Get the kernel weights (for debugging/testing)\n\t */\n\tgetWeights(): Float32Array {\n\t\treturn this.weights;\n\t}\n\n\t/**\n\t * Get kernel size\n\t */\n\tgetSize(): number {\n\t\treturn this.size;\n\t}\n\n\t/**\n\t * Compute variance of radii array (for PBT testing)\n\t */\n\tstatic computeVariance(radii: number[] | Float32Array): number {\n\t\tconst n = radii.length;\n\t\tif (n === 0) return 0;\n\n\t\tlet sum = 0;\n\t\tfor (let i = 0; i < n; i++) {\n\t\t\tsum += radii[i];\n\t\t}\n\t\tconst mean = sum / n;\n\n\t\tlet variance = 0;\n\t\tfor (let i = 0; i < n; i++) {\n\t\t\tconst diff = radii[i] - mean;\n\t\t\tvariance += diff * diff;\n\t\t}\n\n\t\treturn variance / n;\n\t}\n}\n"],"mappings":"AASA,IAAa,IAAb,MAA4B;AAAA,EAC3B;AAAA,EACA;AAAA,EACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,YAAY,IAAe,GAAG,IAAgB,GAAK;AAElD,SAAK,OAAO,IAAO,MAAM,IAAI,IAAO,IAAI,GACxC,KAAK,WAAW,KAAK,MAAM,KAAK,OAAO,CAAA,GACvC,KAAK,UAAU,IAAI,aAAa,KAAK,IAAA,GAErC,KAAK,eAAe,CAAA;AAAA;;;;EAMrB,eAAuB,GAAqB;AAC3C,QAAI,IAAM;AACV,UAAM,IAAkB,IAAI,IAAQ;AAEpC,aAAS,IAAI,GAAG,IAAI,KAAK,MAAM,KAAK;AACnC,YAAM,IAAI,IAAI,KAAK,UACb,IAAS,KAAK,IAAI,EAAE,IAAI,KAAK,CAAA;AACnC,WAAK,QAAQ,CAAA,IAAK,GAClB,KAAO;AAAA;AAIR,aAAS,IAAI,GAAG,IAAI,KAAK,MAAM,IAC9B,MAAK,QAAQ,CAAA,KAAM;AAAA;;;;;;;EAUrB,SAAS,GAA8B;AACtC,UAAM,IAAI,EAAO;AACjB,QAAI,IAAI,EAAG;AAGX,UAAM,IAAgB,IAAI,aAAa,CAAA;AACvC,aAAS,IAAI,GAAG,IAAI,GAAG,IACtB,CAAA,EAAc,CAAA,IAAK,EAAO,CAAA,EAAG;AAI9B,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC3B,UAAI,IAAiB;AAErB,eAAS,IAAI,GAAG,IAAI,KAAK,MAAM,KAAK;AAEnC,cAAM,KAAO,IAAI,IAAI,KAAK,WAAW,KAAK;AAC1C,QAAA,KAAkB,EAAc,CAAA,IAAO,KAAK,QAAQ,CAAA;AAAA;AAGrD,MAAA,EAAO,CAAA,EAAG,SAAS;AAAA;;;;;;;;;EAWrB,cAAc,GAAqB,GAA6B;AAC/D,UAAM,IAAS,IAAI,aAAa,CAAA;AAEhC,aAAS,IAAI,GAAG,IAAI,GAAO,KAAK;AAC/B,UAAI,IAAiB;AAErB,eAAS,IAAI,GAAG,IAAI,KAAK,MAAM,KAAK;AACnC,cAAM,KAAO,IAAI,IAAI,KAAK,WAAW,KAAS;AAC9C,QAAA,KAAkB,EAAM,CAAA,IAAO,KAAK,QAAQ,CAAA;AAAA;AAG7C,MAAA,EAAO,CAAA,IAAK;AAAA;AAGb,WAAO;AAAA;;;;EAMR,aAA2B;AAC1B,WAAO,KAAK;AAAA;;;;EAMb,UAAkB;AACjB,WAAO,KAAK;AAAA;;;;EAMb,OAAO,gBAAgB,GAAwC;AAC9D,UAAM,IAAI,EAAM;AAChB,QAAI,MAAM,EAAG,QAAO;AAEpB,QAAI,IAAM;AACV,aAAS,IAAI,GAAG,IAAI,GAAG,IACtB,CAAA,KAAO,EAAM,CAAA;AAEd,UAAM,IAAO,IAAM;AAEnB,QAAI,IAAW;AACf,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC3B,YAAM,IAAO,EAAM,CAAA,IAAK;AACxB,MAAA,KAAY,IAAO;AAAA;AAGpB,WAAO,IAAW;AAAA"}