{"version":3,"file":"DeviceMotion.js","names":[],"sources":["../../src/motion/DeviceMotion.ts"],"sourcesContent":["/**\n * Device Motion handler for accelerometer/gyroscope input\n * Supports iOS 13+ permission model and falls back to orientation API\n */\n\nexport type DeviceMotionCallback = (data: { x: number; y: number; z: number }) => void;\n\nexport class DeviceMotion {\n\tprivate callback: DeviceMotionCallback;\n\tprivate isListening = false;\n\tprivate useMotionAPI = false;\n\n\tconstructor(callback: DeviceMotionCallback) {\n\t\tthis.callback = callback;\n\t}\n\n\tasync initialize(): Promise<void> {\n\t\t// Check if we're in a browser\n\t\tif (typeof window === 'undefined') {\n\t\t\treturn;\n\t\t}\n\n\t\t// Check if we're in a secure context (required for these APIs)\n\t\tif (!window.isSecureContext) {\n\t\t\tconsole.warn('DeviceMotion APIs require a secure context (HTTPS)');\n\t\t\treturn;\n\t\t}\n\n\t\t// Try DeviceMotionEvent first (accelerometer)\n\t\tif ('DeviceMotionEvent' in window) {\n\t\t\tthis.useMotionAPI = true;\n\t\t} else if ('DeviceOrientationEvent' in window) {\n\t\t\tthis.useMotionAPI = false;\n\t\t} else {\n\t\t\tconsole.log('No device motion/orientation APIs supported');\n\t\t\treturn;\n\t\t}\n\n\t\t// Check if permission is needed before starting\n\t\tconst hasPermission = await this.requestPermission();\n\t\tif (hasPermission) {\n\t\t\tthis.startListening();\n\t\t} else {\n\t\t\tconsole.warn('Device motion permission denied or not available');\n\t\t}\n\t}\n\n\tasync requestPermission(): Promise<boolean> {\n\t\t// For iOS 13+ devices, we need to request permission\n\t\tif (\n\t\t\tthis.useMotionAPI &&\n\t\t\ttypeof (DeviceMotionEvent as unknown as { requestPermission?: () => Promise<string> })\n\t\t\t\t.requestPermission === 'function'\n\t\t) {\n\t\t\ttry {\n\t\t\t\tconst response = await (\n\t\t\t\t\tDeviceMotionEvent as unknown as { requestPermission: () => Promise<string> }\n\t\t\t\t).requestPermission();\n\t\t\t\treturn response === 'granted';\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('Error requesting device motion permission:', error);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (\n\t\t\t!this.useMotionAPI &&\n\t\t\ttypeof (DeviceOrientationEvent as unknown as { requestPermission?: () => Promise<string> })\n\t\t\t\t.requestPermission === 'function'\n\t\t) {\n\t\t\ttry {\n\t\t\t\tconst response = await (\n\t\t\t\t\tDeviceOrientationEvent as unknown as { requestPermission: () => Promise<string> }\n\t\t\t\t).requestPermission();\n\t\t\t\treturn response === 'granted';\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('Error requesting device orientation permission:', error);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// For other devices, permission is implicit\n\t\treturn true;\n\t}\n\n\tprivate startListening(): void {\n\t\tif (this.isListening) return;\n\n\t\tif (this.useMotionAPI) {\n\t\t\twindow.addEventListener('devicemotion', this.handleMotion);\n\t\t} else {\n\t\t\twindow.addEventListener('deviceorientation', this.handleOrientation);\n\t\t}\n\t\tthis.isListening = true;\n\t}\n\n\tprivate handleMotion = (event: DeviceMotionEvent): void => {\n\t\ttry {\n\t\t\tif (!event.accelerationIncludingGravity) return;\n\n\t\t\tconst { x, y, z } = event.accelerationIncludingGravity;\n\t\t\tif (x === null || y === null || z === null) return;\n\n\t\t\t// Normalize accelerometer values\n\t\t\t// Typical range is -9.8 to 9.8 m/sÂ² (gravity)\n\t\t\tconst data = {\n\t\t\t\tx: Math.max(-1, Math.min(1, x / 9.8)),\n\t\t\t\ty: Math.max(-1, Math.min(1, y / 9.8)),\n\t\t\t\tz: Math.max(-1, Math.min(1, z / 9.8)),\n\t\t\t};\n\n\t\t\tthis.callback(data);\n\t\t} catch (error) {\n\t\t\tconsole.error('Error handling device motion:', error);\n\t\t}\n\t};\n\n\tprivate handleOrientation = (event: DeviceOrientationEvent): void => {\n\t\ttry {\n\t\t\tif (event.beta === null || event.gamma === null) return;\n\n\t\t\t// Beta: Front-to-back tilt in degrees (-180 to 180)\n\t\t\t// Gamma: Left-to-right tilt in degrees (-90 to 90)\n\t\t\t// Alpha: Compass direction (0 to 360)\n\n\t\t\tconst data = {\n\t\t\t\tx: event.beta / 90, // Normalize to -2 to 2\n\t\t\t\ty: event.gamma / 90, // Normalize to -1 to 1\n\t\t\t\tz: event.alpha ? event.alpha / 360 : 0, // Normalize to 0 to 1\n\t\t\t};\n\n\t\t\tthis.callback(data);\n\t\t} catch (error) {\n\t\t\tconsole.error('Error handling device orientation:', error);\n\t\t}\n\t};\n\n\tcleanup(): void {\n\t\tif (this.isListening) {\n\t\t\tif (this.useMotionAPI) {\n\t\t\t\twindow.removeEventListener('devicemotion', this.handleMotion);\n\t\t\t} else {\n\t\t\t\twindow.removeEventListener('deviceorientation', this.handleOrientation);\n\t\t\t}\n\t\t\tthis.isListening = false;\n\t\t}\n\t}\n}\n"],"mappings":"AAOA,IAAa,IAAb,MAA0B;AAAA,EACzB;AAAA,EACA,cAAsB;AAAA,EACtB,eAAuB;AAAA,EAEvB,YAAY,GAAgC;AAC3C,SAAK,WAAW;AAAA;EAGjB,MAAM,aAA4B;AAEjC,QAAI,SAAO,SAAW,MAKtB;AAAA,UAAI,CAAC,OAAO,iBAAiB;AAC5B,gBAAQ,KAAK,oDAAA;AACb;AAAA;AAID,UAAI,uBAAuB,OAC1B,MAAK,eAAe;AAAA,eACV,4BAA4B,OACtC,MAAK,eAAe;AAAA,WACd;AACN,gBAAQ,IAAI,6CAAA;AACZ;AAAA;AAKD,MADsB,MAAM,KAAK,kBAAA,IAEhC,KAAK,eAAA,IAEL,QAAQ,KAAK,kDAAA;AAAA;AAAA;EAIf,MAAM,oBAAsC;AAE3C,QACC,KAAK,gBACL,OAAQ,kBACN,qBAAsB,WAExB,KAAI;AAIH,aAHiB,MAChB,kBACC,kBAAA,MACkB;AAAA,aACZ,GAAO;AACf,qBAAQ,MAAM,8CAA8C,CAAA,GACrD;AAAA;aAGR,CAAC,KAAK,gBACN,OAAQ,uBACN,qBAAsB,WAExB,KAAI;AAIH,aAHiB,MAChB,uBACC,kBAAA,MACkB;AAAA,aACZ,GAAO;AACf,qBAAQ,MAAM,mDAAmD,CAAA,GAC1D;AAAA;AAKT,WAAO;AAAA;EAGR,iBAA+B;AAC9B,IAAI,KAAK,gBAEL,KAAK,eACR,OAAO,iBAAiB,gBAAgB,KAAK,YAAA,IAE7C,OAAO,iBAAiB,qBAAqB,KAAK,iBAAA,GAEnD,KAAK,cAAc;AAAA;EAGpB,eAAA,CAAwB,MAAmC;AAC1D,QAAI;AACH,UAAI,CAAC,EAAM,6BAA8B;AAEzC,YAAM,EAAE,GAAA,GAAG,GAAA,GAAG,GAAA,EAAA,IAAM,EAAM;AAC1B,UAAI,MAAM,QAAQ,MAAM,QAAQ,MAAM,KAAM;AAI5C,YAAM,IAAO;AAAA,QACZ,GAAG,KAAK,IAAI,IAAI,KAAK,IAAI,GAAG,IAAI,GAAA,CAAI;AAAA,QACpC,GAAG,KAAK,IAAI,IAAI,KAAK,IAAI,GAAG,IAAI,GAAA,CAAI;AAAA,QACpC,GAAG,KAAK,IAAI,IAAI,KAAK,IAAI,GAAG,IAAI,GAAA,CAAI;AAAA;AAGrC,WAAK,SAAS,CAAA;AAAA,aACN,GAAO;AACf,cAAQ,MAAM,iCAAiC,CAAA;AAAA;;EAIjD,oBAAA,CAA6B,MAAwC;AACpE,QAAI;AACH,UAAI,EAAM,SAAS,QAAQ,EAAM,UAAU,KAAM;AAMjD,YAAM,IAAO;AAAA,QACZ,GAAG,EAAM,OAAO;AAAA,QAChB,GAAG,EAAM,QAAQ;AAAA,QACjB,GAAG,EAAM,QAAQ,EAAM,QAAQ,MAAM;AAAA;AAGtC,WAAK,SAAS,CAAA;AAAA,aACN,GAAO;AACf,cAAQ,MAAM,sCAAsC,CAAA;AAAA;;EAItD,UAAgB;AACf,IAAI,KAAK,gBACJ,KAAK,eACR,OAAO,oBAAoB,gBAAgB,KAAK,YAAA,IAEhD,OAAO,oBAAoB,qBAAqB,KAAK,iBAAA,GAEtD,KAAK,cAAc;AAAA"}