{"version":3,"file":"TinyVectors.js","names":[],"sources":["../../src/svelte/TinyVectors.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { browser } from '../core/browser.js';\n\timport { untrack } from 'svelte';\n\timport { BlobPhysics, type BlobPhysicsConfig } from '../core/BlobPhysics.js';\n\timport { DeviceMotion } from '../motion/DeviceMotion.js';\n\timport { ScrollHandler } from '../motion/ScrollHandler.js';\n\timport { THEME_PRESETS, type ThemePresetName } from '../core/schema.js';\n\timport BlobSVG from './BlobSVG.svelte';\n\n\t// Props\n\tinterface Props {\n\t\t/** Theme preset name */\n\t\ttheme?: ThemePresetName;\n\t\t/** Custom colors (overrides theme preset) */\n\t\tcolors?: string[];\n\t\t/** Whether animation is enabled */\n\t\tanimated?: boolean;\n\t\t/** Component opacity */\n\t\topacity?: number;\n\t\t/** Whether component should load */\n\t\tshouldLoad?: boolean;\n\t\t/** Number of blobs */\n\t\tblobCount?: number;\n\t\t/** Physics configuration */\n\t\tphysicsConfig?: Partial<BlobPhysicsConfig>;\n\t\t/** Enable device motion (accelerometer) */\n\t\tenableDeviceMotion?: boolean;\n\t\t/** Enable scroll physics */\n\t\tenableScrollPhysics?: boolean;\n\t}\n\n\tlet {\n\t\ttheme = 'tinyland',\n\t\tcolors = [],\n\t\tanimated = true,\n\t\topacity = 1,\n\t\tshouldLoad = true,\n\t\tblobCount = 8,\n\t\tphysicsConfig = {},\n\t\tenableDeviceMotion = true,\n\t\tenableScrollPhysics = true,\n\t}: Props = $props();\n\n\t// State - use regular variables for non-reactive state\n\tlet containerElement: HTMLDivElement | undefined = $state(undefined);\n\tlet blobs = $state<ReturnType<BlobPhysics['getBlobs']>>([]);\n\tlet isReady = $state(false);\n\tlet isMobileDevice = $state(false);\n\tlet hasAccelerometerAccess = $state(false);\n\n\t// Non-reactive state (no $state needed - these don't trigger re-renders)\n\tlet physics: BlobPhysics | null = null;\n\tlet animationFrame: number | null = null;\n\tlet lastTime = 0;\n\tlet deviceMotion: DeviceMotion | null = null;\n\tlet scrollHandler: ScrollHandler | null = null;\n\tlet gravityX = 0;\n\tlet gravityY = 0;\n\tlet tiltX = 0;\n\tlet tiltY = 0;\n\tlet tiltZ = 0;\n\n\t// Get theme colors - use $derived.by for computed values\n\tconst themeColors = $derived.by(() => {\n\t\tif (colors.length > 0) return colors;\n\t\tconst preset = THEME_PRESETS[theme];\n\t\tif (!preset || !preset.hasVectors) return [];\n\t\treturn preset.colors.map((c) => c.color);\n\t});\n\n\t// Default physics config\n\tconst defaultPhysicsConfig: BlobPhysicsConfig = {\n\t\tantiClusteringStrength: 0.15,\n\t\tbounceDamping: 0.7,\n\t\tdeformationSpeed: 0.5,\n\t\tterritoryStrength: 0.1,\n\t\tviscosity: 0.3,\n\t};\n\n\t// Detect mobile device\n\tconst detectMobileDevice = (): boolean => {\n\t\tif (!browser) return false;\n\t\tconst userAgent = navigator.userAgent.toLowerCase();\n\t\tconst mobileKeywords = ['mobile', 'android', 'iphone', 'ipad', 'ipod', 'blackberry', 'windows phone'];\n\t\tconst isMobileUserAgent = mobileKeywords.some((keyword) => userAgent.includes(keyword));\n\t\tconst isMobileScreen = window.innerWidth <= 768 || window.innerHeight <= 768;\n\t\tconst hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n\t\tconst hasOrientationAPI = 'DeviceOrientationEvent' in window;\n\t\treturn (isMobileUserAgent || (isMobileScreen && hasTouchScreen)) && hasOrientationAPI;\n\t};\n\n\t// Handle device motion - no reactive state updates\n\tconst handleDeviceMotion = (motionData: { x: number; y: number; z: number }) => {\n\t\tif (!hasAccelerometerAccess || !physics) return;\n\n\t\ttiltX = motionData.x;\n\t\ttiltY = motionData.y;\n\t\ttiltZ = motionData.z;\n\n\t\t// Convert to gravity vector\n\t\tconst newX = motionData.y * 0.8;\n\t\tconst newY = -motionData.x * 0.8;\n\n\t\t// Smooth the values\n\t\tgravityX = newX * 0.7 + gravityX * 0.3;\n\t\tgravityY = newY * 0.7 + gravityY * 0.3;\n\n\t\t// Pass to physics\n\t\tphysics.setGravity({ x: gravityX, y: gravityY });\n\t\tphysics.setTilt({ x: tiltX, y: tiltY, z: tiltZ });\n\t};\n\n\t// Request accelerometer permission\n\tconst requestAccelerometerPermission = async (): Promise<void> => {\n\t\tif (!isMobileDevice || !deviceMotion) return;\n\n\t\ttry {\n\t\t\tconst hasPermission = await deviceMotion.requestPermission();\n\t\t\thasAccelerometerAccess = hasPermission;\n\t\t\tif (hasPermission) {\n\t\t\t\tconsole.log('[TinyVectors] Accelerometer access granted');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log('[TinyVectors] Could not request accelerometer permission:', error);\n\t\t\thasAccelerometerAccess = false;\n\t\t}\n\t};\n\n\t// Handle scroll - no reactive state updates\n\tconst handleScroll = (event: WheelEvent) => {\n\t\tif (!scrollHandler || !physics) return;\n\n\t\tconst scrollMagnitude = Math.abs(event.deltaY);\n\t\tif (scrollMagnitude > 50) {\n\t\t\tevent.preventDefault();\n\t\t}\n\n\t\tscrollHandler.handleScroll(event);\n\t\tconst stickiness = scrollHandler.getStickiness() * 0.12;\n\t\tphysics.setScrollStickiness(stickiness);\n\t};\n\n\t// Animation tick function - updates blobs state once per frame\n\tfunction tick(currentTime: number) {\n\t\tconst dt = Math.min((currentTime - lastTime) / 1000, 0.033);\n\t\tlastTime = currentTime;\n\n\t\tif (physics) {\n\t\t\tphysics.tick(dt, currentTime / 1000);\n\t\t\t// Update blobs state - this triggers re-render\n\t\t\tblobs = physics.getBlobs(themeColors);\n\t\t}\n\n\t\tanimationFrame = requestAnimationFrame(tick);\n\t}\n\n\tfunction startAnimation() {\n\t\tif (animationFrame) return;\n\t\tlastTime = performance.now();\n\t\tanimationFrame = requestAnimationFrame(tick);\n\t}\n\n\tfunction stopAnimation() {\n\t\tif (animationFrame) {\n\t\t\tcancelAnimationFrame(animationFrame);\n\t\t\tanimationFrame = null;\n\t\t}\n\t}\n\n\t// Single initialization effect\n\t$effect(() => {\n\t\tif (!browser || !shouldLoad) return;\n\n\t\t// Use untrack to prevent this effect from re-running on state changes\n\t\tuntrack(() => {\n\t\t\tconst config = { ...defaultPhysicsConfig, ...physicsConfig };\n\t\t\tphysics = new BlobPhysics(blobCount, config);\n\n\t\t\tphysics.init().then(() => {\n\t\t\t\t// Detect mobile\n\t\t\t\tisMobileDevice = detectMobileDevice();\n\t\t\t\tisReady = true;\n\n\t\t\t\t// Initialize device motion on mobile\n\t\t\t\tif (enableDeviceMotion && isMobileDevice) {\n\t\t\t\t\tdeviceMotion = new DeviceMotion(handleDeviceMotion);\n\t\t\t\t\tdeviceMotion.initialize().then(() => {\n\t\t\t\t\t\tsetTimeout(requestAccelerometerPermission, 1000);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Initialize scroll handler\n\t\t\t\tif (enableScrollPhysics) {\n\t\t\t\t\tscrollHandler = new ScrollHandler();\n\t\t\t\t}\n\n\t\t\t\t// Start animation if enabled\n\t\t\t\tif (animated) {\n\t\t\t\t\tstartAnimation();\n\t\t\t\t} else if (physics) {\n\t\t\t\t\tblobs = physics.getBlobs(themeColors);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Set up scroll listener\n\t\t\tif (enableScrollPhysics) {\n\t\t\t\twindow.addEventListener('wheel', handleScroll, { passive: false });\n\t\t\t}\n\t\t});\n\n\t\treturn () => {\n\t\t\tstopAnimation();\n\t\t\tif (enableScrollPhysics && browser) {\n\t\t\t\twindow.removeEventListener('wheel', handleScroll);\n\t\t\t}\n\t\t\tdeviceMotion?.cleanup();\n\t\t\tphysics?.dispose();\n\t\t\tphysics = null;\n\t\t};\n\t});\n\n\t// Handle animated prop changes\n\t$effect(() => {\n\t\tif (!isReady) return;\n\n\t\tif (animated) {\n\t\t\tstartAnimation();\n\t\t} else {\n\t\t\tstopAnimation();\n\t\t}\n\t});\n</script>\n\n{#if shouldLoad && themeColors.length > 0}\n\t<div\n\t\tbind:this={containerElement}\n\t\tclass=\"absolute inset-0 overflow-hidden pointer-events-none\"\n\t\tstyle:opacity\n\t\tstyle:transition=\"opacity 0.8s ease-in-out\"\n\t\taria-hidden=\"true\"\n\t\trole=\"presentation\"\n\t>\n\t\t<BlobSVG {blobs} {containerElement} {physics} />\n\n\t\t<!-- Mobile accelerometer status (debug) -->\n\t\t{#if isMobileDevice && false}\n\t\t\t<div class=\"pointer-events-none fixed top-2 right-2 text-xs opacity-30\">\n\t\t\t\tüì± {hasAccelerometerAccess ? '‚úÖ Tilt Active' : '‚ùå Tilt Disabled'}\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n{/if}\n"],"mappings":"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"}